{% extends "base.html" %}

{% block title %}{% if employee %}직원 수정{% else %}직원 등록{% endif %} - 인사카드 관리 시스템{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/layouts/section-nav.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/employee-form.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/layouts/right-sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/tree-selector.css') }}">
{% endblock %}

{% block content %}
{# Employee role 여부 플래그 #}
{% set is_employee_role = current_user and current_user.role == 'employee' %}

{% from 'macros/_navigation.html' import section_nav %}
<div class="form-page-layout-with-sidebar">
    {# 좌측: 섹션 네비게이션 #}
    {{ section_nav('인사정보 등록', employee.name if employee else '신규 등록', variant='form', employee=employee, is_employee_role=is_employee_role) }}

    {# 메인 콘텐츠: 폼 #}
    <main class="form-main-content">
        {# 페이지 헤더 #}
        <div class="form-page-header">
            {% if is_employee_role %}
            <h1 class="form-page-title">내 정보 수정</h1>
            {% else %}
            <h1 class="form-page-title">{% if employee %}직원 정보 수정{% else %}신규 직원 등록{% endif %}</h1>
            {% endif %}
            <div class="form-page-actions">
                <a href="{% if employee %}{{ url_for('employees.employee_detail', employee_id=employee.id) }}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>취소</span>
                </a>
            </div>
        </div>

        {% if is_employee_role %}
        <div class="alert alert-info alert-info-box">
            <i class="fas fa-info-circle"></i>
            <span>연락처, 주소, 이력 정보 등 일부 항목만 수정 가능합니다. 소속정보, 급여 등은 인사담당자에게 문의하세요.</span>
        </div>
        {% endif %}

        <form method="POST" action="{% if employee %}{{ url_for('employees.employee_update', employee_id=employee.id) }}{% else %}{{ url_for('employees.employee_create') }}{% endif %}" class="employee-form" id="employeeForm">

            {# 섹션 1: 개인 기본정보 #}
            {% include 'partials/employee_form/_personal_info.html' %}

            {# 섹션 2: 소속정보 - Employee는 읽기전용으로 표시 #}
            {% if not is_employee_role %}
            {% include 'partials/employee_form/_organization_info.html' %}
            {% else %}
            {# Employee용 소속정보 (읽기 전용) #}
            <section class="form-section" id="organization-info">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-building"></i>
                            소속정보 <span class="badge badge-secondary">읽기 전용</span>
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">사번</label>
                                <input type="text" class="form-input" value="{{ employee.employee_number or '-' }}" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">부서</label>
                                <input type="text" class="form-input" value="{{ employee.department or '-' }}" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">팀</label>
                                <input type="text" class="form-input" value="{{ employee.team or '-' }}" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">직급</label>
                                <input type="text" class="form-input" value="{{ employee.position or '-' }}" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">직책</label>
                                <input type="text" class="form-input" value="{{ employee.job_title or '-' }}" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">근무지</label>
                                <input type="text" class="form-input" value="{{ employee.work_location or '-' }}" readonly disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

            {# 섹션 3: 계약정보 - Employee는 숨김 #}
            {% if not is_employee_role %}
            {% include 'partials/employee_form/_contract_info.html' %}
            {% endif %}

            {# 섹션 4: 학력정보 (동적 폼) #}
            {% include 'partials/employee_form/_education_info.html' %}

            {# 섹션 5: 경력정보 (동적 폼) #}
            {% include 'partials/employee_form/_career_info.html' %}

            {# 섹션 6: 자격증 (동적 폼) #}
            {% include 'partials/employee_form/_certificate_info.html' %}

            {# 섹션 7: 언어능력 (동적 폼) #}
            {% include 'partials/employee_form/_language_info.html' %}

            {# 섹션 8: 프로젝트 (동적 폼) - Employee는 숨김 #}
            {% if not is_employee_role %}
            {% include 'partials/employee_form/_project_info.html' %}
            {% endif %}

            {# 섹션 9: 병역정보 #}
            {% include 'partials/employee_form/_military_info.html' %}

            {# 섹션 10: 가족사항 (동적 폼) #}
            {% include 'partials/employee_form/_family_info.html' %}

            {# 섹션 11: 급여정보 - Employee는 숨김 #}
            {% if not is_employee_role %}
            {% include 'partials/employee_form/_salary_info.html' %}
            {% endif %}

            {# 섹션 12: 4대보험 - Employee는 숨김 #}
            {% if not is_employee_role %}
            {% include 'partials/employee_form/_insurance_info.html' %}
            {% endif %}

            {# 폼 제출 버튼 #}
            {% include 'partials/employee_form/_submit_section.html' %}

        </form>
    </main>

    {% if not is_employee_role %}
    {% include 'partials/_attachment_sidebar.html' %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/tree-selector.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pages/employee-form.js') }}"></script>
<script>
    // 조직 트리 선택기 초기화
    document.addEventListener('DOMContentLoaded', function() {
        new TreeSelector({
            inputId: 'organization_display',
            hiddenInputId: 'organization_id',
            modalId: 'orgTreeSelectorModal',
            apiUrl: '/admin/api/organizations?format=tree',
            allowEmpty: true,
            onSelect: function(selected) {
                if (selected) {
                    console.log('Selected organization:', selected);
                }
            }
        });
    });
</script>
{% endblock %}
