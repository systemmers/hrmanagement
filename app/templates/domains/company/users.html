{% extends "shared/base.html" %}
{% from 'shared/macros/_pagination.html' import render_pagination %}
{% from 'shared/macros/_filters.html' import filter_bar, search_box, filter_select %}

{% block title %}계정관리 - {{ company.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/company/users.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/employee/account-provision-modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/filter.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title-row">
        <h1 class="page-title">계정관리</h1>
        <div class="page-actions">
            <a href="{{ url_for('corporate.dashboard') }}" class="btn btn--secondary">
                <i class="fas fa-arrow-left"></i>
                <span>대시보드로</span>
            </a>
            <button type="button" class="btn btn--primary" id="openAccountProvisionModal">
                <i class="fas fa-id-card"></i>
                계정 발급
            </button>
        </div>
    </div>
    <p class="page-description">{{ company.name }} 법인 계정 목록입니다. (총 {{ pagination.total }}명{% if pagination.pages > 1 %}, {{ pagination.page }}/{{ pagination.pages }} 페이지{% endif %})</p>
</div>

<!-- 필터 바 (Phase 33) -->
{% call filter_bar(mode='url', css_class='filter-bar--simple') %}
    {{ search_box(
        placeholder='이름, 아이디, 이메일 검색...',
        value=request.args.get('search', '')
    ) }}
    {{ filter_select('filter-role', 'role', filter_options.roles,
        request.args.get('role', ''), '전체 역할') }}
    {{ filter_select('filter-status', 'status', filter_options.statuses,
        request.args.get('status', ''), '전체 상태') }}
    {{ filter_select('filter-contract', 'contract_status', filter_options.contract_statuses,
        request.args.get('contract_status', ''), '전체 계약상태') }}

    <select id="sortSelect" class="filter-select filter-sort" data-filter-exclude>
        <option value="">정렬</option>
        <option value="name" {% if request.args.get('sort') == 'name' and request.args.get('order', 'asc') == 'asc' %}selected{% endif %}>이름 (오름차순)</option>
        <option value="name-desc" {% if request.args.get('sort') == 'name' and request.args.get('order') == 'desc' %}selected{% endif %}>이름 (내림차순)</option>
        <option value="username" {% if request.args.get('sort') == 'username' and request.args.get('order', 'asc') == 'asc' %}selected{% endif %}>아이디 (오름차순)</option>
        <option value="created_at-desc" {% if request.args.get('sort') == 'created_at' and request.args.get('order') == 'desc' %}selected{% endif %}>최신순</option>
    </select>
{% endcall %}

<!-- 사용자 목록 테이블 -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>No.</th>
                <th>아이디</th>
                <th>이름</th>
                <th>이메일</th>
                <th>전화번호</th>
                <th>역할</th>
                <th>상태</th>
                <th>계약상태</th>
                <th>생성일</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.company_sequence }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.name or '-' }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.phone or '-' }}</td>
                <td>
                    {# 역할: 계약 승인 상태에서만 역할 표시, 그 외 모든 상태는 대기 #}
                    {% if user.contract_status == 'approved' %}
                        {% if user.role == 'admin' %}
                        <span class="badge badge--primary">관리자</span>
                        {% elif user.role == 'manager' %}
                        <span class="badge badge--info">매니저</span>
                        {% else %}
                        <span class="badge badge--secondary">직원</span>
                        {% endif %}
                    {% else %}
                    <span class="badge badge--warning">대기</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <span class="badge badge--success">활성</span>
                    {% else %}
                    <span class="badge badge--danger">비활성</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.contract_status == 'approved' %}
                    <span class="badge badge--success">승인됨</span>
                    {% elif user.contract_status == 'requested' %}
                    <span class="badge badge--warning">대기중</span>
                    {% elif user.contract_status == 'rejected' %}
                    <span class="badge badge--danger">거절됨</span>
                    {% elif user.contract_status == 'terminated' %}
                    <span class="badge badge--secondary">종료</span>
                    {% elif user.contract_status == 'termination_requested' %}
                    <span class="badge badge--warning">종료대기</span>
                    {% else %}
                    <span class="badge badge--light">계약없음</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at[:10] if user.created_at else '-' }}</td>
                <td>
                    <div class="table-actions">
                        <button class="btn--icon" title="수정" data-action="edit-user" data-user-id="{{ user.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% if user.id != session.get('user_id') %}
                        <div class="dropdown">
                            <button class="btn--icon" title="상태변경" data-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                {% if not user.is_active %}
                                <a class="dropdown-item" href="#" data-action="change-status" data-user-id="{{ user.id }}" data-status="active">
                                    <i class="fas fa-check text-success"></i> 활성화
                                </a>
                                {% endif %}
                                {% if user.is_active %}
                                <a class="dropdown-item" href="#" data-action="change-status" data-user-id="{{ user.id }}" data-status="dormant">
                                    <i class="fas fa-moon text-warning"></i> 휴면 처리
                                </a>
                                {% endif %}
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#" data-action="change-status" data-user-id="{{ user.id }}" data-status="withdrawn">
                                    <i class="fas fa-user-times"></i> 계정 탈퇴
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 페이지네이션 (Phase 32) -->
{{ render_pagination(pagination, per_page=per_page) }}

{% if users|length == 0 %}
<div class="empty-state-large">
    <i class="fas fa-users"></i>
    {% if request.args.get('search') or request.args.get('role') or request.args.get('status') or request.args.get('contract_status') %}
    <p>검색 조건에 맞는 사용자가 없습니다.</p>
    <a href="{{ url_for('corporate.users') }}" class="btn btn--secondary">
        <i class="fas fa-undo"></i>
        필터 초기화
    </a>
    {% else %}
    <p>등록된 사용자가 없습니다.</p>
    <button type="button" class="btn btn--primary" id="openAccountProvisionModalEmpty">
        <i class="fas fa-id-card"></i>
        계정 발급
    </button>
    {% endif %}
</div>
{% endif %}

{# 계정 발급 모달 #}
{% include 'domains/employee/partials/_account_provision_modal.html' %}

{# 사용자 수정 모달 #}
{% include 'domains/company/partials/_user_edit_modal.html' %}
{% endblock %}

{% block extra_js %}
<script type="module" src="{{ url_for('static', filename='js/shared/components/filter-bar.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/company/pages/users.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/employee/pages/account-provision-modal.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/company/pages/user-edit-modal.js') }}"></script>
{% endblock %}
