{% extends "shared/base.html" %}

{% block title %}조직 관리 - 인사카드 관리 시스템{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/company/organization.css') }}">
{% endblock %}

{% macro render_tree_node(org) %}
<div class="tree-node" data-id="{{ org.id }}" data-type="{{ org.org_type }}"
     {% if org.org_type != 'company' %}draggable="true"{% endif %}>
    <div class="tree-node-content" data-action="select-org" data-org-id="{{ org.id }}">
        {% if org.children and org.children|length > 0 %}
        <span class="tree-toggle" data-action="toggle-node">
            <i class="fas fa-chevron-right"></i>
        </span>
        {% else %}
        <span class="tree-toggle-placeholder"></span>
        {% endif %}
        <span class="tree-icon">
            {% if org.org_type == 'company' %}
            <i class="fas fa-building"></i>
            {% elif org.org_type == 'division' %}
            <i class="fas fa-layer-group"></i>
            {% elif org.org_type == 'department' %}
            <i class="fas fa-users"></i>
            {% elif org.org_type == 'team' %}
            <i class="fas fa-user-friends"></i>
            {% else %}
            <i class="fas fa-folder"></i>
            {% endif %}
        </span>
        <span class="tree-label">{{ org.name }}</span>
        {% if org.total_member_count is defined and org.total_member_count > 0 %}
        <span class="tree-member-count">({{ org.total_member_count }}명)</span>
        {% endif %}
        {% if org.code %}
        <span class="tree-code">{{ org.code }}</span>
        {% endif %}
    </div>
    {% if org.children and org.children|length > 0 %}
    <div class="tree-children">
        {% for child in org.children %}
            {{ render_tree_node(child) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}

{% block content %}
<div class="page-header">
    <div class="page-title-section">
        <h2 class="page-title">
            <i class="fas fa-sitemap"></i>
            조직 관리
        </h2>
        <p class="page-subtitle">회사의 조직 구조를 관리합니다</p>
    </div>
    <div class="page-actions">
        <button class="btn btn--primary" data-action="add-org">
            <i class="fas fa-plus"></i>
            조직 추가
        </button>
    </div>
</div>

<!-- 통계 카드 -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-building"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">전체 조직</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-city"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.by_type.get('company', 0) }}</div>
            <div class="stat-label">회사</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.by_type.get('division', 0) }}</div>
            <div class="stat-label">본부</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.by_type.get('department', 0) }}</div>
            <div class="stat-label">부서</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-user-friends"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.by_type.get('team', 0) }}</div>
            <div class="stat-label">팀</div>
        </div>
    </div>
</div>

<!-- 조직 트리 & 상세 정보 -->
<div class="org-container">
    <!-- 조직 트리 -->
    <div class="org-tree-panel">
        <div class="panel-header">
            <h3><i class="fas fa-folder-tree"></i> 조직 구조</h3>
            <div class="panel-actions">
                <button class="btn btn--icon" id="toggleTreeBtn" data-action="toggle-tree" title="전체 펼치기">
                    <i class="fas fa-expand-alt"></i>
                    <span class="sr-only">전체 펼치기</span>
                </button>
            </div>
        </div>
        <div class="panel-body">
            <div class="org-tree" id="orgTree">
                {% for org in tree %}
                    {{ render_tree_node(org) }}
                {% else %}
                    <div class="empty-tree">
                        <i class="fas fa-folder-open"></i>
                        <p>등록된 조직이 없습니다.</p>
                        <button class="btn btn--primary" data-action="add-org">
                            첫 번째 조직 추가
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 조직 상세 정보 -->
    <div class="org-detail-panel" id="orgDetailPanel">
        <div class="panel-header">
            <h3><i class="fas fa-info-circle"></i> 조직 정보</h3>
        </div>
        <div class="panel-body">
            <div class="empty-detail">
                <i class="fas fa-hand-pointer"></i>
                <p>조직을 선택하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 조직 추가/수정 모달 -->
<div class="modal" id="orgModal">
    <div class="modal__content">
        <div class="modal__header">
            <h3 id="orgModalTitle" class="modal__title">조직 추가</h3>
            <button class="modal-close" data-action="close-org-modal">&times;</button>
        </div>
        <form id="orgForm" data-action="save-org">
            <div class="modal__body">
                <input type="hidden" id="orgId" name="id">

                <div class="form__group">
                    <label for="orgName" class="form__label required">조직명</label>
                    <input type="text" id="orgName" name="name" class="form__input" required>
                </div>

                <div class="form__row">
                    <div class="form__group">
                        <label for="orgCode" class="form__label">조직 코드</label>
                        <input type="text" id="orgCode" name="code" class="form__input"
                               placeholder="예: DEV, HR, SALES">
                    </div>
                    <div class="form__group">
                        <label for="orgType" class="form__label required">조직 유형</label>
                        <select id="orgType" name="org_type" class="form__select" required>
                            <option value="company">회사</option>
                            <option value="division">본부</option>
                            <option value="department" selected>부서</option>
                            <option value="team">팀</option>
                            <option value="unit">파트</option>
                        </select>
                    </div>
                </div>

                <div class="form__group">
                    <label for="orgParent" class="form__label">상위 조직</label>
                    <select id="orgParent" name="parent_id" class="form__select">
                        <option value="">없음 (최상위)</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}">{{ org.path }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form__group">
                    <label for="orgDescription" class="form__label">설명</label>
                    <textarea id="orgDescription" name="description" class="form__textarea" rows="3"></textarea>
                </div>

                <div class="form__group">
                    <label for="orgManager" class="form__label">조직장</label>
                    <select id="orgManager" name="manager_id" class="form__select">
                        <option value="">선택하세요</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.name }}{% if emp.position %} ({{ emp.position }}){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form__row">
                    <div class="form__group form__group--half">
                        <label for="leaderPhone" class="form__label">조직장 내선번호</label>
                        <input type="text" id="leaderPhone" name="leader_phone"
                               class="form__input" placeholder="예: 1234" maxlength="20">
                    </div>
                    <div class="form__group form__group--half">
                        <label for="deptPhone" class="form__label">부서 내선번호</label>
                        <input type="text" id="deptPhone" name="department_phone"
                               class="form__input" placeholder="예: 1200" maxlength="20">
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" data-action="close-org-modal">취소</button>
                <button type="submit" class="btn btn--primary">저장</button>
            </div>
        </form>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal" id="deleteModal">
    <div class="modal__content modal__content--sm">
        <div class="modal__header">
            <h3 class="modal__title">조직 삭제</h3>
            <button class="modal__close" data-action="close-delete-modal">&times;</button>
        </div>
        <div class="modal__body">
            <p id="deleteMessage">이 조직을 삭제하시겠습니까?</p>
            <div class="form__group">
                <label class="checkbox-label">
                    <input type="checkbox" id="cascadeDelete">
                    <span>하위 조직도 함께 삭제</span>
                </label>
            </div>
        </div>
        <div class="modal__footer">
            <button type="button" class="btn btn--secondary" data-action="close-delete-modal">취소</button>
            <button type="button" class="btn btn--danger" data-action="confirm-delete">삭제</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/domains/company/pages/organization.js') }}"></script>
{% endblock %}
