{#
    통합 프로필 상세 페이지

    법인 직원(corporate)과 개인 계정(personal) 모두 지원
    account_type에 따라 표시되는 섹션이 다름

    모드:
    - VIEW 모드: employee/profile 조회 (기본)
    - CREATE 모드: action='create' 전달 시, 신규 직원 등록

    컨텍스트 변수:
    - employee 또는 profile: 프로필 데이터 객체 (CREATE 모드에서는 None)
    - is_corporate: 법인 소속 여부
    - account_type: 'corporate', 'personal', 'corporate_admin'
    - action: 'create' (신규 등록), 'view' (기본)
    - sections: 사용 가능한 섹션 목록
    - basic_info, organization_info, education_list 등: 섹션별 데이터
#}
{% extends "shared/base.html" %}

{# 변수 통합: employee 또는 profile 중 사용 가능한 것 사용 #}
{% set profile_data = employee if employee is defined else profile %}
{% set profile_name = profile_data.name if profile_data else '신규 직원' %}
{# CREATE 모드 플래그 #}
{% set is_create_mode = action is defined and action == 'create' %}

{% block title %}{% if is_create_mode %}신규 직원 등록{% else %}{{ profile_name }} - {{ '인사카드' if page_mode == 'hr_card' else '프로필' }}{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/layouts/section-nav.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/layouts/right-sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/attachment.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/attachment/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/profile-header.css') }}">
{% if page_mode == 'hr_card' and not is_create_mode %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/businesscard/card.css') }}">
{% endif %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/card.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/table.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/employee/detail.css') }}">
{# CREATE 모드용 인라인 편집 CSS #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/inline-edit.css') }}">
{% if is_create_mode %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/tree-selector.css') }}">
{% endif %}
{% endblock %}

{% block content %}
{# 내부 섹션 네비게이션 제거 - 사이드바로 통합 (2026-01-12) #}

{# 계정 타입에 따른 body 클래스 #}
<div class="detail-page-layout detail-page-layout--no-sidebar-nav {{ 'create-mode' if is_create_mode else '' }}"
         data-account-type="{{ account_type }}"
         {% if is_create_mode %}data-create-mode="true"{% endif %}
         {% if account_type == 'corporate' and profile_data and profile_data.id %}data-employee-id="{{ profile_data.id }}"{% endif %}
         {% if account_type == 'personal' and profile_data and profile_data.id %}data-profile-id="{{ profile_data.id }}"{% endif %}>
    {# 메인 콘텐츠 #}
    <div class="detail-main-content">
        {# 페이지 헤더 #}
        <div class="detail-page-header">
            {% if is_create_mode %}
                <h1 class="detail-page-title">신규 직원 등록</h1>
            {% elif page_mode == 'hr_card' %}
                <h1 class="detail-page-title">직원 상세 정보</h1>
            {% else %}
                <h1 class="detail-page-title">내 프로필</h1>
            {% endif %}

            <div class="detail-page-actions">
                {# CREATE 모드: 등록/취소 버튼 #}
                {% if is_create_mode %}
                <a href="{{ url_for('employees.employee_list') }}" class="btn btn--secondary">
                    <i class="fas fa-times"></i>
                    <span>취소</span>
                </a>
                <button type="button" class="btn btn--primary" data-action="submit-all">
                    <i class="fas fa-save"></i>
                    <span>직원 등록</span>
                </button>
                {% else %}
                {# 목록으로 버튼 (인사카드 페이지에서 관리자만) #}
                {% if page_mode == 'hr_card' and current_user and current_user.role != 'employee' %}
                <a href="{{ url_for('employees.employee_list') }}" class="btn btn--secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>목록으로</span>
                </a>
                {% endif %}
                {% endif %}

                {# 수정 버튼 제거 - 인라인 편집으로 대체 (2026-01-16) #}

                {# 삭제 버튼 (인사카드 페이지에서 관리자만, CREATE 모드 제외) #}
                {% if not is_create_mode and page_mode == 'hr_card' and current_user and current_user.is_admin and account_type != 'corporate_admin' %}
                <button class="btn btn--danger" data-action="delete-employee" data-employee-id="{{ profile_data.id }}" data-employee-name="{{ profile_name }}">
                    <i class="fas fa-trash"></i>
                    <span>삭제</span>
                </button>
                {% endif %}

                {# 프로필 동기화 버튼 (개인계약이 있는 경우 관리자/매니저만, CREATE 모드 제외) #}
                {% if not is_create_mode and page_mode == 'hr_card' and person_contract and current_user and current_user.role in ['admin', 'manager'] %}
                <button class="btn btn--secondary" id="syncProfileBtn" data-contract-id="{{ person_contract.id }}">
                    <i class="fas fa-sync"></i>
                    <span>프로필 동기화</span>
                </button>
                {% endif %}
            </div>
        </div>

        {% if is_create_mode %}
        {# ===== CREATE 모드: 신규 직원 등록 폼 ===== #}
        {# 계정 정보 섹션 (필수) #}
        {% include 'domains/employee/partials/detail/_create_account_section.html' %}

        {# 기본정보 섹션 #}
        {% include 'domains/employee/partials/detail/_basic_info.html' %}

        {% else %}
        {# ===== VIEW/EDIT 모드: 기존 상세 페이지 ===== #}
        {# 직원/프로필 헤더 카드 - Profile Header v3.3 #}
        {# 개인/법인 모두 동일한 헤더 컴포넌트 사용, 테마는 account_type에 따라 자동 적용 #}
        {% include 'shared/partials/_profile_header.html' %}

        {# 섹션 1-6: 기본정보 (개인정보, 소속정보, 계약정보, 급여정보, 복리후생, 4대보험) #}
        {% include 'domains/employee/partials/detail/_basic_info.html' %}

        {# 섹션 7-11: 이력 및 경력 (학력, 경력, 자격증, 언어능력, 병역/프로젝트/수상) #}
        {% include 'domains/employee/partials/detail/_history_info.html' %}

        {# 인사카드 전용: 계정정보 (법인 계정만, 개인 계정 제외) #}
        {% if page_mode == 'hr_card' and is_corporate and account_type != 'corporate_admin' %}
            {% include 'domains/employee/partials/detail/_account_info.html' %}
        {% endif %}

        {# 섹션 12-14: 인사기록 (인사카드 페이지 전용) #}
        {% if page_mode == 'hr_card' and account_type != 'corporate_admin' %}
            {% include 'domains/employee/partials/detail/_hr_records.html' %}
        {% endif %}
        {% endif %}
    </div>
</div>

{# 모바일 섹션 네비게이션 토글 버튼 #}
<button class="mobile-section-nav-toggle" id="mobileNavToggle">
    <i class="fas fa-bars"></i>
</button>

{# 모바일 오버레이 #}
<div class="section-nav-overlay" id="sectionNavOverlay"></div>

{# 명함 업로드 모달 (인사카드 페이지 전용) #}
{% if page_mode == 'hr_card' and can_edit_business_card %}
{% include 'shared/partials/_business_card_modal.html' %}
{% endif %}
{% endblock %}

{% block sidebar_right %}
{# CREATE 모드에서는 첨부파일 사이드바 숨김 #}
{% if not is_create_mode %}
{# 프로필/인사카드 모두 첨부파일 사이드바 표시 #}
{# 프로필: is_readonly=False (수정/삭제 가능), 인사카드: is_readonly=True (조회만) #}
{% include 'shared/partials/_attachment_sidebar.html' %}
{% endif %}
{% endblock %}

{% block extra_js %}
{% if is_create_mode %}
{# CREATE 모드: 인라인 편집 매니저 (CREATE 모드로 초기화) #}
<script type="module">
    import { initInlineEditCreate } from '{{ url_for('static', filename='js/shared/components/inline-edit-manager.js') }}';

    document.addEventListener('DOMContentLoaded', () => {
        // CREATE 모드로 InlineEditManager 초기화
        initInlineEditCreate({
            requiredFields: ['name', 'account_username', 'account_email'],
            createApiUrl: '{{ url_for('employees.employee_create') }}'
        });
    });
</script>
{% else %}
{# VIEW/EDIT 모드: 기존 스크립트 #}
{# QR코드 라이브러리 (명함 도메인) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/employee/pages/detail.js') }}"></script>
{% if page_mode == 'hr_card' %}
<script src="{{ url_for('static', filename='js/domains/employee/components/business-card.js') }}"></script>
{% endif %}

{# 프로필 동기화 스크립트 #}
{% if person_contract %}
<script src="{{ url_for('static', filename='js/domains/user/pages/profile-sync.js') }}"></script>
{% endif %}
{% endif %}
{% endblock %}
