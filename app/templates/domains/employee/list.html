{% extends "shared/base.html" %}
{% from 'shared/macros/_avatar.html' import avatar_image %}
{% from 'shared/macros/_filters.html' import filter_bar, search_box, filter_select, sort_select %}
{% from 'shared/macros/_pagination.html' import render_pagination %}

{% block title %}직원 목록 - 인사카드 관리 시스템{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/filter.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components/modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/employee/account-provision-modal.css') }}">
{# BusinessCard 도메인 CSS (플랫 모던) #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/domains/businesscard/card.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title-row">
        <h1 class="page-title">직원 목록</h1>
        <div class="page-actions">
            <div class="view-toggle-group">
                <button class="view-toggle-btn {{ 'active' if view_mode == 'list' or not view_mode else '' }}" data-view="list" title="목록형 보기">
                    <i class="fas fa-list"></i>
                </button>
                <button class="view-toggle-btn {{ 'active' if view_mode == 'card' else '' }}" data-view="card" title="카드형 보기">
                    <i class="fas fa-th"></i>
                </button>
                <button class="view-toggle-btn {{ 'active' if view_mode == 'namecard' else '' }}" data-view="namecard" title="명함형 보기">
                    <i class="fas fa-id-card"></i>
                </button>
            </div>
            <button type="button" class="btn btn--secondary" id="openAccountProvisionModal">
                <i class="fas fa-id-card"></i>
                <span>계정 발급</span>
            </button>
            <a href="{{ url_for('employees.employee_new') }}" class="btn btn--primary">
                <i class="fas fa-plus"></i>
                <span>직원 등록</span>
            </a>
        </div>
    </div>
    <p class="page-description">총 {{ pagination.total }}명의 직원이 있습니다.</p>
</div>

<!-- 필터 바 (매크로 기반) - 정렬 포함 -->
{% call filter_bar(mode='url', css_class='filter-bar--simple') %}
    {{ search_box(placeholder='이름, 부서, 직급 검색...', value=request.args.get('search', '')) }}
    {{ filter_select('filter-department', 'department', classification_options.departments, request.args.get('department', ''), '전체 부서') }}
    {{ filter_select('filter-position', 'position', classification_options.positions, request.args.get('position', ''), '전체 직급') }}
    {{ filter_select('filter-status', 'status', classification_options.statuses, request.args.get('status', ''), '전체 상태') }}
    {# 정렬 셀렉트 - 필터바 내 오른쪽 정렬 (FilterBar 이벤트에서 제외) #}
    <select id="sortSelect" class="filter-select filter-sort" aria-label="정렬" data-filter-exclude>
        <option value="" {% if not request.args.get('sort') %}selected{% endif %}>정렬</option>
        <option value="name" {% if request.args.get('sort') == 'name' and request.args.get('order') != 'desc' %}selected{% endif %}>이름 (오름차순)</option>
        <option value="name-desc" {% if request.args.get('sort') == 'name' and request.args.get('order') == 'desc' %}selected{% endif %}>이름 (내림차순)</option>
        <option value="department" {% if request.args.get('sort') == 'department' and request.args.get('order') != 'desc' %}selected{% endif %}>부서 (오름차순)</option>
        <option value="department-desc" {% if request.args.get('sort') == 'department' and request.args.get('order') == 'desc' %}selected{% endif %}>부서 (내림차순)</option>
        <option value="position" {% if request.args.get('sort') == 'position' and request.args.get('order') != 'desc' %}selected{% endif %}>직급 (오름차순)</option>
        <option value="position-desc" {% if request.args.get('sort') == 'position' and request.args.get('order') == 'desc' %}selected{% endif %}>직급 (내림차순)</option>
        <option value="hire_date" {% if request.args.get('sort') == 'hire_date' and request.args.get('order') != 'desc' %}selected{% endif %}>입사일 (오래된순)</option>
        <option value="hire_date-desc" {% if request.args.get('sort') == 'hire_date' and request.args.get('order') == 'desc' %}selected{% endif %}>입사일 (최신순)</option>
    </select>
{% endcall %}

<!-- 목록형 뷰 (view_mode: {{ view_mode }}) -->
<div class="table-container {{ 'd-none' if view_mode and view_mode != 'list' else '' }}" id="list-view">
    <table class="data-table sortable-table">
        <thead>
            <tr>
                <th data-sort="id">ID</th>
                <th>계정유형</th>
                <th>아이디</th>
                <th data-sort="name">이름</th>
                <th data-sort="department">부서</th>
                <th data-sort="position">직급</th>
                <th data-sort="hire_date">입사일</th>
                <th>전화번호</th>
                <th>이메일</th>
                <th data-sort="status">상태</th>
                <th>계약</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td>{{ employee.id }}</td>
                <td>{{ employee.account_type_label or '-' }}</td>
                <td>{{ employee.username or '-' }}</td>
                <td>
                    <div class="d-flex items-center gap-2">
                        {{ avatar_image(employee.photo, employee.name, size='xs') }}
                        <span>{{ employee.name }}</span>
                    </div>
                </td>
                <td>{{ employee.department }}</td>
                <td>{{ employee.position }}</td>
                <td>{{ employee.hire_date }}</td>
                <td>{{ employee.phone }}</td>
                <td>{{ employee.email }}</td>
                <td>
                    <span class="badge {{ get_status_badge_class(employee.status) }}">
                        {{ get_status_text(employee.status) }}
                    </span>
                </td>
                <td>
                    {# 21번 원칙: 계약 상태 표시 및 요청 버튼 #}
                    {% if employee.contract_status == 'no_account' %}
                        <span class="badge badge--secondary" title="계정 없음">-</span>
                    {% elif employee.contract_status == 'none' %}
                        <button class="btn btn--sm btn--outline-primary btn-contract-request"
                                data-user-id="{{ employee.user_id }}"
                                data-employee-name="{{ employee.name }}"
                                title="계약 요청">
                            <i class="fas fa-file-signature"></i>
                            <span>요청</span>
                        </button>
                    {% elif employee.contract_status == 'requested' %}
                        <span class="badge badge--warning">대기중</span>
                    {% elif employee.contract_status == 'approved' %}
                        <span class="badge badge--success">계약완료</span>
                    {% elif employee.contract_status == 'rejected' %}
                        <span class="badge badge--danger">거절됨</span>
                    {% elif employee.contract_status == 'terminated' %}
                        <span class="badge badge--secondary">종료</span>
                    {% elif employee.contract_status == 'termination_requested' %}
                        <span class="badge badge--warning">종료대기</span>
                    {% endif %}
                </td>
                <td>
                    <div class="table-actions">
                        <a href="{{ url_for('employees.employee_detail', employee_id=employee.id) }}" class="btn--icon" title="상세">
                            <i class="fas fa-eye"></i>
                        </a>
                        {# 수정 버튼 제거 - 인라인 편집으로 대체 (2026-01-16) #}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 카드형 뷰 -->
<div class="employee-grid {{ 'd-none' if view_mode != 'card' else '' }}" id="card-view">
    {% for employee in employees %}
    <div class="employee-card" data-href="{{ url_for('employees.employee_detail', employee_id=employee.id) }}">
        <div class="employee-status {{ employee.status }}"></div>
        {{ avatar_image(employee.photo, employee.name, size='lg', extra_class='employee-photo') }}
        <h3 class="employee-name">{{ employee.name }}</h3>
        <p class="employee-position">{{ employee.department }} · {{ employee.position }}</p>
        <div class="employee-meta">
            <div class="employee-meta-item">
                <i class="fas fa-calendar"></i>
                <span>입사일: {{ employee.hire_date }}</span>
            </div>
            <div class="employee-meta-item">
                <i class="fas fa-phone"></i>
                <span>{{ employee.phone }}</span>
            </div>
            {# 21번 원칙: 계약 상태 표시 #}
            <div class="employee-meta-item">
                <i class="fas fa-file-contract"></i>
                {% if employee.contract_status == 'no_account' %}
                    <span class="text-muted">계정 없음</span>
                {% elif employee.contract_status == 'none' %}
                    <span class="text-info">계약 미요청</span>
                {% elif employee.contract_status == 'requested' %}
                    <span class="text-warning">계약 대기중</span>
                {% elif employee.contract_status == 'approved' %}
                    <span class="text-success">계약 완료</span>
                {% elif employee.contract_status == 'rejected' %}
                    <span class="text-danger">계약 거절</span>
                {% elif employee.contract_status == 'terminated' %}
                    <span class="text-secondary">계약 종료</span>
                {% elif employee.contract_status == 'termination_requested' %}
                    <span class="text-warning">종료 대기</span>
                {% endif %}
            </div>
        </div>
        <div class="employee-actions">
            <a href="{{ url_for('employees.employee_detail', employee_id=employee.id) }}" class="btn btn--secondary btn--sm">
                <i class="fas fa-eye"></i>
                <span>보기</span>
            </a>
            {# 수정 버튼 제거 - 인라인 편집으로 대체 (2026-01-16) #}
            {# 21번 원칙: 계약 요청 버튼 (계정 있고 계약 없는 경우만) #}
            {% if employee.contract_status == 'none' %}
            <button class="btn btn--primary btn--sm btn-contract-request"
                    data-user-id="{{ employee.user_id }}"
                    data-employee-name="{{ employee.name }}">
                <i class="fas fa-file-signature"></i>
                <span>계약</span>
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- 명함형 뷰 (BusinessCard 도메인) -->
<div class="bc-grid {{ 'd-none' if view_mode != 'namecard' else '' }}" id="namecard-view">
    {% for employee in employees %}
        {# 명함 데이터 조회 - business_cards_map에서 해당 직원의 명함 이미지 가져오기 #}
        {% set emp_cards = business_cards_map.get(employee.id, {}) if business_cards_map else {} %}
        {% set business_card_front = emp_cards.get('front') %}
        {% set business_card_back = emp_cards.get('back') %}
        {% include 'domains/businesscard/partials/_card.html' %}
    {% endfor %}
</div>

<!-- 페이지네이션 (Phase 32) -->
{{ render_pagination(pagination, per_page=per_page) }}

{% if employees|length == 0 %}
<div class="empty-state empty-state-large">
    <i class="fas fa-users"></i>
    <p>등록된 직원이 없습니다.</p>
</div>
{% endif %}

{# 계정 발급 모달 #}
{% include 'domains/employee/partials/_account_provision_modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/shared/components/filter-bar.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/employee/pages/list.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/domains/employee/pages/account-provision-modal.js') }}"></script>
{# BusinessCard 도메인 모듈 (명함형 뷰용) #}
<script type="module" src="{{ url_for('static', filename='js/domains/businesscard/index.js') }}"></script>
{% endblock %}

