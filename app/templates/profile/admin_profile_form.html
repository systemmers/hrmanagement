{% extends 'base.html' %}

{% set is_create = (mode == 'create') %}

{% block title %}법인 관리자 프로필 {{ '생성' if is_create else '수정' }} - HR Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/register.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-profile.css') }}">
{% endblock %}

{% block content %}
<div class="admin-profile-form">
    <div class="admin-profile-form__header">
        <h1 class="admin-profile-form__title">법인 관리자 프로필 {{ '생성' if is_create else '수정' }}</h1>
        <p class="admin-profile-form__subtitle">{{ '프로필 정보를 입력하여 서비스를 시작하세요' if is_create else '프로필 정보를 수정합니다' }}</p>
    </div>

    <!-- Flash 메시지 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert--{{ category }}" style="margin-bottom: var(--spacing-4);">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" class="admin-profile-form__form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- 기본 정보 섹션 -->
        <div class="admin-profile-form__section">
            <h3 class="admin-profile-form__section-title">
                <i class="fas fa-user"></i> 기본 정보
            </h3>

            <!-- 프로필 사진 업로드 -->
            <div class="admin-profile-form__photo-section">
                <div class="admin-profile-form__photo-preview" id="photoPreview">
                    {% if form_data.get('photo') %}
                    <img src="{{ form_data.get('photo') }}" alt="프로필 사진" id="previewImage">
                    {% else %}
                    <div class="admin-profile-form__photo-placeholder" id="photoPlaceholder">
                        <i class="fas fa-user"></i>
                        <span>사진 미등록</span>
                    </div>
                    {% endif %}
                </div>
                <div class="admin-profile-form__photo-controls">
                    <label class="admin-profile-form__label">프로필 사진</label>
                    <input type="file" id="photoFile" name="photoFile"
                           accept="image/jpeg,image/png,image/gif,image/webp"
                           class="admin-profile-form__input-file" style="display: none;">
                    <input type="hidden" id="photo" name="photo" value="{{ form_data.get('photo', '') }}">
                    <div class="admin-profile-form__photo-buttons">
                        <button type="button" class="admin-profile-form__btn admin-profile-form__btn--secondary admin-profile-form__btn--sm" id="selectPhotoBtn">
                            <i class="fas fa-camera"></i> 사진 선택
                        </button>
                        {% if form_data.get('photo') and not form_data.get('photo').startswith('http') %}
                        <button type="button" class="admin-profile-form__btn admin-profile-form__btn--danger admin-profile-form__btn--sm" id="deletePhotoBtn">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                        {% endif %}
                    </div>
                    <small class="admin-profile-form__help">JPG, PNG, GIF, WebP (최대 5MB)</small>
                </div>
            </div>

            <div class="admin-profile-form__row">
                <div class="admin-profile-form__group">
                    <label for="name" class="admin-profile-form__label">
                        이름 <span class="text-error-500">*</span>
                    </label>
                    <input type="text"
                           id="name"
                           name="name"
                           class="admin-profile-form__input"
                           placeholder="홍길동"
                           value="{{ form_data.get('name', '') }}"
                           required>
                </div>

                <div class="admin-profile-form__group">
                    <label for="english_name" class="admin-profile-form__label">
                        영문 이름
                    </label>
                    <input type="text"
                           id="english_name"
                           name="english_name"
                           class="admin-profile-form__input"
                           placeholder="Gil Dong Hong"
                           value="{{ form_data.get('english_name', '') }}">
                </div>
            </div>

            <div class="admin-profile-form__row">
                <div class="admin-profile-form__group">
                    <label for="position" class="admin-profile-form__label">
                        직책
                    </label>
                    <input type="text"
                           id="position"
                           name="position"
                           class="admin-profile-form__input"
                           placeholder="대표이사, CEO, CFO 등"
                           value="{{ form_data.get('position', '') }}">
                </div>

                <div class="admin-profile-form__group">
                    <label for="department" class="admin-profile-form__label">
                        소속 부서
                    </label>
                    <input type="text"
                           id="department"
                           name="department"
                           class="admin-profile-form__input"
                           placeholder="경영지원팀"
                           value="{{ form_data.get('department', '') }}">
                </div>
            </div>
        </div>

        <!-- 연락처 정보 섹션 -->
        <div class="admin-profile-form__section">
            <h3 class="admin-profile-form__section-title">
                <i class="fas fa-phone"></i> 연락처 정보
            </h3>

            <div class="admin-profile-form__row">
                <div class="admin-profile-form__group">
                    <label for="mobile_phone" class="admin-profile-form__label">
                        휴대전화
                    </label>
                    <input type="tel"
                           id="mobile_phone"
                           name="mobile_phone"
                           class="admin-profile-form__input"
                           placeholder="010-0000-0000"
                           value="{{ form_data.get('mobile_phone', '') }}">
                </div>

                <div class="admin-profile-form__group">
                    <label for="office_phone" class="admin-profile-form__label">
                        사무실 전화
                    </label>
                    <input type="tel"
                           id="office_phone"
                           name="office_phone"
                           class="admin-profile-form__input"
                           placeholder="02-0000-0000"
                           value="{{ form_data.get('office_phone', '') }}">
                </div>
            </div>

            <div class="admin-profile-form__group">
                <label for="email" class="admin-profile-form__label">
                    이메일
                </label>
                <input type="email"
                       id="email"
                       name="email"
                       class="admin-profile-form__input"
                       placeholder="admin@company.com"
                       value="{{ form_data.get('email', '') or (user.email if is_create and user else '') }}">
            </div>
        </div>

        <!-- 소개 섹션 -->
        <div class="admin-profile-form__section">
            <h3 class="admin-profile-form__section-title">
                <i class="fas fa-comment"></i> 소개
            </h3>

            <div class="admin-profile-form__group">
                <label for="bio" class="admin-profile-form__label">
                    간략한 소개
                </label>
                <textarea id="bio"
                          name="bio"
                          class="admin-profile-form__textarea"
                          placeholder="간략한 자기소개를 입력하세요">{{ form_data.get('bio', '') }}</textarea>
            </div>
        </div>

        <!-- 버튼 -->
        <div class="admin-profile-form__actions">
            <a href="{{ url_for('main.index') if is_create else url_for('profile.view') }}" class="admin-profile-form__btn admin-profile-form__btn--secondary">
                취소
            </a>
            <button type="submit" class="admin-profile-form__btn admin-profile-form__btn--primary">
                <i class="fas fa-{{ 'check' if is_create else 'save' }}"></i> {{ '프로필 생성' if is_create else '저장' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- JS: utils/formatting.js - 전화번호 자동 포맷팅 (DOMContentLoaded 시 자동 초기화) -->
<script src="{{ url_for('static', filename='js/utils/formatting.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 사진 선택 버튼
    const selectPhotoBtn = document.getElementById('selectPhotoBtn');
    const photoFileInput = document.getElementById('photoFile');
    const photoHiddenInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');

    if (selectPhotoBtn && photoFileInput) {
        selectPhotoBtn.addEventListener('click', function() {
            photoFileInput.click();
        });

        photoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 파일 크기 체크 (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('파일 크기는 5MB 이하여야 합니다.');
                    return;
                }

                // 미리보기 표시
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML = '<img src="' + e.target.result + '" alt="프로필 사진" id="previewImage">';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // 사진 삭제 버튼
    if (deletePhotoBtn) {
        deletePhotoBtn.addEventListener('click', function() {
            if (confirm('프로필 사진을 삭제하시겠습니까?')) {
                photoPreview.innerHTML = '<div class="admin-profile-form__photo-placeholder" id="photoPlaceholder"><i class="fas fa-user"></i><span>사진 미등록</span></div>';
                photoHiddenInput.value = '';
                photoFileInput.value = '';
                deletePhotoBtn.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
