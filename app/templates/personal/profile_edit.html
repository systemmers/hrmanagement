{% extends "base.html" %}

{% block title %}프로필 수정 - 인사카드 관리 시스템{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/layouts/section-nav.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/employee-form.css') }}">
{% endblock %}

{% block content %}
{% from 'macros/_navigation.html' import section_nav %}
<div class="form-page-layout-with-sidebar">
    {# 좌측: 섹션 네비게이션 #}
    {{ section_nav('프로필 수정', profile.name if profile and profile.name else user.username, variant='profile') }}

    {# 메인 콘텐츠: 폼 #}
    <main class="form-main-content">
        {# 페이지 헤더 #}
        <div class="form-page-header">
            <h1 class="form-page-title">프로필 수정</h1>
            <div class="form-page-actions">
                <a href="{{ url_for('personal.profile') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>프로필로</span>
                </a>
            </div>
        </div>

        <form method="POST" action="{{ url_for('personal.profile_edit') }}" class="employee-form" id="profileForm" enctype="multipart/form-data">

            {# 섹션 1: 개인 기본정보 #}
            {% include 'partials/profile_form/_personal_basic_info.html' %}

            {# 섹션 2: 연락처 정보 #}
            {% include 'partials/profile_form/_contact_info.html' %}

            {# 섹션 3: 주소 정보 #}
            {% include 'partials/profile_form/_address_info.html' %}

            {# 섹션 4: 기타 정보 #}
            {% include 'partials/profile_form/_other_info.html' %}

            {# 섹션 5: 공개 설정 #}
            {% include 'partials/profile_form/_visibility_settings.html' %}

            {# 폼 제출 버튼 #}
            {% with cancel_url=url_for('personal.profile') %}
            {% include 'partials/profile_form/_submit_section.html' %}
            {% endwith %}

        </form>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/formatting.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 전화번호 입력 필드 자동 포맷팅 초기화
    if (window.HRFormatters) {
        window.HRFormatters.initPhoneInputs();
    }

    // 섹션 네비게이션 활성화
    const navItems = document.querySelectorAll('.section-nav-item');
    const sections = document.querySelectorAll('.form-section');

    // 스크롤 시 현재 섹션 하이라이트
    function updateActiveNav() {
        let currentSection = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop - 150;
            if (window.scrollY >= sectionTop) {
                currentSection = section.getAttribute('id');
            }
        });

        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href') === '#' + currentSection) {
                item.classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateActiveNav);

    // 네비게이션 클릭 시 부드러운 스크롤
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // 프로필 사진 업로드
    const selectPhotoBtn = document.getElementById('selectPhotoBtn');
    const photoFile = document.getElementById('photoFile');
    const photoPreview = document.getElementById('photoPreview');
    const photoInput = document.getElementById('photo');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');

    if (selectPhotoBtn && photoFile) {
        selectPhotoBtn.addEventListener('click', function() {
            photoFile.click();
        });

        photoFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 파일 크기 검사 (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('파일 크기는 5MB 이하여야 합니다.');
                    return;
                }

                // 미리보기 표시
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML = '<img src="' + e.target.result + '" alt="프로필 사진" id="previewImage">';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    if (deletePhotoBtn) {
        deletePhotoBtn.addEventListener('click', function() {
            if (confirm('프로필 사진을 삭제하시겠습니까?')) {
                photoPreview.innerHTML = '<div class="photo-placeholder" id="photoPlaceholder"><i class="fas fa-user"></i><span>사진 미등록</span></div>';
                if (photoInput) photoInput.value = '';
                if (photoFile) photoFile.value = '';
            }
        });
    }

    // 주소 검색 (카카오 주소 API)
    const searchAddressBtn = document.getElementById('searchAddressBtn');
    if (searchAddressBtn) {
        searchAddressBtn.addEventListener('click', function() {
            new daum.Postcode({
                oncomplete: function(data) {
                    document.getElementById('postal_code').value = data.zonecode;
                    document.getElementById('address').value = data.roadAddress || data.jibunAddress;
                    document.getElementById('detailed_address').focus();
                }
            }).open();
        });
    }
});
</script>
{# 카카오 주소 API #}
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
{% endblock %}
