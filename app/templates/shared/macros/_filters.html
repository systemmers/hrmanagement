{#
    통합 필터 매크로 (SSOT)
    - 3가지 모드 지원: url (서버 필터링), client (클라이언트 필터링), form (폼 제출)
    - FieldOptions 및 classification_options 둘 다 수용
    - 접근성: aria-* 속성 포함

    Last Updated: 2026-01-06
    - 체크박스 필터 -> 단일 선택 셀렉트로 통합
    - 활성 필터 태그 제거 (간소화)
#}

{# 메인 필터 바 - caller() 패턴으로 내부 콘텐츠 주입 #}
{% macro filter_bar(id='filter-bar', mode='url', action='', css_class='') %}
<div id="{{ id }}" class="filter-bar {{ css_class }}"
     data-filter-bar data-mode="{{ mode }}"
     {% if mode == 'form' and action %}data-action="{{ action }}"{% endif %}
     role="search" aria-label="필터">
    {{ caller() }}
</div>
{% endmacro %}

{# 검색 박스 #}
{% macro search_box(id='searchInput', name='search', placeholder='검색...', value='', icon='fa-search') %}
<div class="filter-search">
    <i class="fas {{ icon }} filter-search__icon" aria-hidden="true"></i>
    <input type="text" id="{{ id }}" name="{{ name }}"
           class="filter-search__input" placeholder="{{ placeholder }}"
           value="{{ value }}" aria-label="{{ placeholder }}">
</div>
{% endmacro %}

{# 단일 선택 필터 - options: FieldOptions.* 또는 classification_options.* #}
{% macro filter_select(id, name, options, selected='', placeholder='전체', css_class='', label='') %}
{% if label %}
<div class="filter-group">
    <label for="{{ id }}" class="filter-label">{{ label }}</label>
    <select id="{{ id }}" name="{{ name }}" class="filter-select {{ css_class }}"
            data-filter="{{ name }}" aria-label="{{ label }}">
        <option value="">{{ placeholder }}</option>
        {% for opt in options %}
        <option value="{{ opt.value }}" {% if opt.value|string == selected|string %}selected{% endif %}>
            {{ opt.label }}
        </option>
        {% endfor %}
    </select>
</div>
{% else %}
<select id="{{ id }}" name="{{ name }}" class="filter-select {{ css_class }}"
        data-filter="{{ name }}" aria-label="{{ placeholder }}">
    <option value="">{{ placeholder }}</option>
    {% for opt in options %}
    <option value="{{ opt.value }}" {% if opt.value|string == selected|string %}selected{% endif %}>
        {{ opt.label }}
    </option>
    {% endfor %}
</select>
{% endif %}
{% endmacro %}

{#
    [DEPRECATED] 다중 선택 필터 - 단일 선택 filter_select로 대체 권장
    다중 선택이 필요한 특수 케이스에서만 사용
#}
{% macro filter_multi_select(id, name, options, selected=[], placeholder='전체', css_class='', label='', size=5) %}
<div class="filter-group">
    {% if label %}
    <label for="{{ id }}" class="filter-label">{{ label }}</label>
    {% endif %}
    <select id="{{ id }}" name="{{ name }}" class="filter-select filter-select--multi {{ css_class }}"
            multiple size="{{ size }}" data-filter="{{ name }}" aria-label="{{ label or placeholder }}">
        {% for opt in options %}
        <option value="{{ opt.value }}" {% if opt.value in selected %}selected{% endif %}>
            {{ opt.label }}
        </option>
        {% endfor %}
    </select>
</div>
{% endmacro %}

{# 정렬 셀렉트 - 필터바 내 오른쪽 정렬용 #}
{% macro sort_select(id, options, selected_sort='', selected_order='', placeholder='정렬', css_class='') %}
<select id="{{ id }}" class="filter-select filter-sort {{ css_class }}"
        aria-label="{{ placeholder }}">
    <option value="">{{ placeholder }}</option>
    {% for opt in options %}
    {% set is_selected = (opt.value == selected_sort and selected_order != 'desc') or
                         (opt.value ~ '-desc' == selected_sort ~ '-' ~ selected_order if selected_order == 'desc' else false) %}
    <option value="{{ opt.value }}" {% if opt.value == selected_sort and selected_order != 'desc' %}selected{% endif %}>
        {{ opt.label_asc if opt.label_asc else opt.label ~ ' (오름차순)' }}
    </option>
    <option value="{{ opt.value }}-desc" {% if opt.value == selected_sort and selected_order == 'desc' %}selected{% endif %}>
        {{ opt.label_desc if opt.label_desc else opt.label ~ ' (내림차순)' }}
    </option>
    {% endfor %}
</select>
{% endmacro %}

{# 필터 버튼 그룹 - Reset 버튼 기본 비활성화 (활성 필터 태그로 대체) #}
{% macro filter_buttons(show_reset=false, show_submit=false, reset_text='초기화', submit_text='필터') %}
<div class="filter-buttons">
    {% if show_reset %}
    <button type="button" class="btn btn-secondary filter-reset" data-action="reset">
        <i class="fas fa-undo" aria-hidden="true"></i>
        <span>{{ reset_text }}</span>
    </button>
    {% endif %}
    {% if show_submit %}
    <button type="submit" class="btn btn-primary filter-submit" data-action="submit">
        <i class="fas fa-filter" aria-hidden="true"></i>
        <span>{{ submit_text }}</span>
    </button>
    {% endif %}
</div>
{% endmacro %}

{# 필터 토글 버튼 (모바일용) #}
{% macro filter_toggle(target_id='filter-content', text='필터') %}
<button type="button" class="btn btn-outline filter-toggle"
        data-toggle="filter" data-target="{{ target_id }}"
        aria-expanded="false" aria-controls="{{ target_id }}">
    <i class="fas fa-filter" aria-hidden="true"></i>
    <span>{{ text }}</span>
</button>
{% endmacro %}

{#
    [DEPRECATED] 활성 필터 태그 - 2026-01-06 간소화로 제거
    필요시 사용 가능하나 권장하지 않음
#}
{% macro active_filter_tags(filters, show_clear_all=true) %}
{% if filters %}
<div class="active-filters" role="region" aria-label="적용된 필터">
    {% for filter in filters %}
    <span class="filter-tag" data-type="{{ filter.type }}" data-value="{{ filter.value }}">
        <span class="filter-tag__label">{{ filter.label }}</span>
        <button type="button" class="filter-tag__remove"
                aria-label="{{ filter.label }} 필터 제거"
                data-action="remove-filter">
            <i class="fas fa-times" aria-hidden="true"></i>
        </button>
    </span>
    {% endfor %}
    {% if show_clear_all and filters|length > 1 %}
    <button type="button" class="filter-clear-all" data-action="clear-all">
        <i class="fas fa-times-circle" aria-hidden="true"></i>
        <span>전체 해제</span>
    </button>
    {% endif %}
</div>
{% endif %}
{% endmacro %}

{# 필터 결과 카운트 #}
{% macro filter_result_count(count, total=none, text='결과') %}
<div class="filter-result-count" role="status" aria-live="polite">
    <span class="filter-result-count__number">{{ count }}</span>
    {% if total is not none %}
    <span class="filter-result-count__total">/ {{ total }}</span>
    {% endif %}
    <span class="filter-result-count__text">{{ text }}</span>
</div>
{% endmacro %}

{#
    사용 예시 (2026-01-06 업데이트):

    1. URL 모드 - 권장 패턴 (employees/list.html):
    {% from "shared/macros/_filters.html" import filter_bar, search_box, filter_select %}

    {% call filter_bar(mode='url', css_class='filter-bar--simple') %}
        {{ search_box(placeholder='이름, 부서, 직급 검색...', value=request.args.get('search', '')) }}
        {{ filter_select('department', 'department', classification_options.departments, request.args.get('department', ''), '전체 부서') }}
        {{ filter_select('position', 'position', classification_options.positions, request.args.get('position', ''), '전체 직급') }}
        {{ filter_select('status', 'status', field_options.EMPLOYEE_STATUS, request.args.get('status', ''), '전체 상태') }}
    {% endcall %}

    2. 클라이언트 모드 (contracts/company_list.html):
    {% call filter_bar(mode='client', css_class='filter-bar--simple') %}
        {{ search_box(placeholder='계약 검색...') }}
        {{ filter_select('statusFilter', 'status', field_options.CONTRACT_STATUS, '', '전체 상태') }}
    {% endcall %}

    3. 폼 모드 (platform/*.html):
    {% call filter_bar(mode='form', action=url_for('platform.users'), css_class='filter-bar--simple') %}
        {{ search_box(name='search', value=request.args.get('search', '')) }}
        {{ filter_select('accountType', 'account_type', field_options.ACCOUNT_TYPE, request.args.get('account_type', ''), '전체 계정') }}
        {{ filter_buttons(show_submit=true) }}
    {% endcall %}
#}
