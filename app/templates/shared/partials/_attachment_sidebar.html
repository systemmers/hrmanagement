{# ========================================
   첨부파일 사이드바 공유 템플릿
   - 필요 변수: attachment_list
   - 선택 변수: is_readonly (True일 경우 업로드/삭제 버튼 숨김)
   - 사용처: employee_detail.html, employee_form.html, profile, mypage
   - Phase 33: BEM 클래스 적용
   - 2026-01-12: 세로형 컴팩트 카드 적용 (1열 그리드)
   - 2026-01-12: MIME 타입(image/png) 및 확장자(png) 모두 지원
   - Phase 5.3: 파일 검색/필터링 기능 추가
   - Phase 5.4: 파일 미리보기 모달 추가
   ======================================== #}
<aside class="right-sidebar">
    <div class="right-sidebar-header">
        <div class="right-sidebar-header-row">
            <h2 class="right-sidebar-title">개인 첨부서류</h2>
            {% if not is_readonly %}
            <button type="button" class="btn-ai-analyze" id="btnAiAnalyze" title="AI 첨부서류 분석">
                <i class="fas fa-wand-magic-sparkles"></i>
                <span>AI 분석</span>
            </button>
            {% endif %}
        </div>
    </div>
    <div class="right-sidebar-content">
        {# Phase 5.3: 파일 검색/필터링 바 #}
        {% if attachment_list and attachment_list|length > 0 %}
        <div class="filter-bar filter-bar--file" id="fileFilterBar">
            <div class="filter-search">
                <span class="filter-search__icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </span>
                <input type="text" class="filter-search__input" id="fileSearchInput" placeholder="파일명 검색...">
            </div>
            <select class="filter-select" id="fileTypeFilter">
                <option value="">모든 유형</option>
                <option value="image">이미지</option>
                <option value="pdf">PDF</option>
                <option value="document">문서</option>
                <option value="other">기타</option>
            </select>
            <select class="filter-select" id="fileSortSelect">
                <option value="date-desc">최신순</option>
                <option value="date-asc">오래된순</option>
                <option value="name-asc">이름순</option>
                <option value="size-desc">크기순</option>
            </select>
            <span class="filter-result-count" id="fileResultCount">
                <span class="filter-result-count__number">{{ attachment_list|length }}</span>개 파일
            </span>
        </div>
        {% endif %}
        {# 조회 전용 모드가 아닐 때만 업로드 영역 표시 #}
        {% if not is_readonly %}
        {# owner_type/owner_id 결정: page_mode와 account_type 기반 #}
        {# page_mode='hr_card' (직원 상세/수정) → owner_type='employee' #}
        {# account_type='personal' (개인 프로필) → owner_type='profile' #}
        {# account_type='corporate' (법인 직원 본인 프로필) → owner_type='employee' #}
        {% set owner_type = 'employee' if page_mode == 'hr_card' or account_type == 'corporate' else 'profile' %}
        {% set owner_id = (employee.id if employee is defined else profile.id) if (employee is defined or profile is defined) else profile_data.id %}
        <div class="file-upload-area file-upload-area--compact" id="fileUploadArea"
             data-owner-type="{{ owner_type }}"
             data-owner-id="{{ owner_id }}">
            <div class="file-upload-area__icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="file-upload-area__text">파일을 드래그하거나 클릭</div>
            <div class="file-upload-area__hint">PDF, JPG, PNG (최대 10MB)</div>
        </div>
        {% endif %}

        <div id="fileList" class="file-list file-list--cards">
            {% if attachment_list %}
                {% for attachment in attachment_list|sort(attribute='category') %}
                {# file_path 정규화: /static/으로 시작하지 않으면 /static/uploads/ 접두사 추가 #}
                {% set file_url = attachment.file_path if attachment.file_path.startswith('/static/') else '/static/uploads/' ~ attachment.file_path %}
                {# file_type: MIME 타입(image/png) 또는 확장자(png) 모두 지원 #}
                {% set is_image = attachment.file_type.startswith('image/') or attachment.file_type in ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'] %}
                {% set is_pdf = attachment.file_type == 'application/pdf' or attachment.file_type == 'pdf' %}
                {% set is_word = attachment.file_type in ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'doc', 'docx'] %}
                {% set is_excel = attachment.file_type in ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'xls', 'xlsx'] %}
                {% set is_ppt = attachment.file_type in ['application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', 'ppt', 'pptx'] %}
                {% set is_archive = attachment.file_type in ['application/zip', 'application/x-zip-compressed', 'zip'] %}
                <div class="file-card file-card--vertical file-card--compact file-card--uploaded" data-attachment-id="{{ attachment.id }}">
                    <div class="file-card__icon {% if is_image %}file-card__icon--thumbnail{% endif %}">
                        {% if is_image %}
                            <img src="{{ file_url }}"
                                 alt="{{ attachment.file_name }}"
                                 loading="lazy">
                        {% elif is_pdf %}
                            <i class="fas fa-file-pdf"></i>
                        {% elif is_word %}
                            <i class="fas fa-file-word"></i>
                        {% elif is_excel %}
                            <i class="fas fa-file-excel"></i>
                        {% elif is_ppt %}
                            <i class="fas fa-file-powerpoint"></i>
                        {% elif is_archive %}
                            <i class="fas fa-file-archive"></i>
                        {% else %}
                            <i class="fas fa-file"></i>
                        {% endif %}
                    </div>
                    <div class="file-card__info">
                        <div class="file-card__label">{{ attachment.category }}</div>
                        <div class="file-card__name">{{ attachment.file_name }}</div>
                        <div class="file-card__meta">
                            <span class="file-card__date">{{ attachment.upload_date[:10] if attachment.upload_date else '' }}</span>
                            <span class="file-card__size">{{ (attachment.file_size / 1024)|round(1) }}KB</span>
                        </div>
                    </div>
                    <div class="file-card__actions file-card__actions--bottom">
                        <button type="button" class="file-card__btn btn-preview-attachment"
                                data-file-url="{{ file_url }}"
                                data-file-name="{{ attachment.file_name }}"
                                data-file-type="{{ attachment.file_type }}"
                                data-file-size="{{ (attachment.file_size / 1024)|round(1) }}"
                                data-attachment-id="{{ attachment.id }}"
                                title="미리보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="{{ file_url }}" download class="file-card__btn" title="다운로드">
                            <i class="fas fa-download"></i>
                        </a>
                        {# 조회 전용 모드가 아닐 때만 삭제 버튼 표시 #}
                        {% if not is_readonly %}
                        <button type="button" class="file-card__btn file-card__btn--danger btn-delete-attachment" data-id="{{ attachment.id }}" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="file-empty-state">
                    <i class="file-empty-state__icon fas fa-folder-open"></i>
                    <p class="file-empty-state__text">등록된 첨부파일이 없습니다</p>
                </div>
            {% endif %}
        </div>
    </div>
</aside>

{# Phase 5.4: 파일 미리보기 모달 #}
<div class="modal modal--file-preview" id="filePreviewModal">
    <div class="modal__backdrop"></div>
    <div class="modal__container">
        <div class="modal__header">
            <span class="modal__title" id="previewFileName">파일명</span>
            <button class="btn btn--icon modal__close" type="button" data-modal-close title="닫기">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal__body" id="previewContent">
            {# 이미지/PDF/미지원 파일이 동적으로 렌더링됨 #}
        </div>
        <div class="modal__footer">
            <span class="file-preview__info" id="previewFileInfo">- KB | -</span>
            <div class="file-preview__actions">
                <a href="#" class="btn btn--secondary btn--sm" id="previewDownloadBtn" download>
                    <i class="fas fa-download"></i> 다운로드
                </a>
                <a href="#" class="btn btn--outline btn--sm" id="previewNewTabBtn" target="_blank">
                    <i class="fas fa-external-link-alt"></i> 새 탭에서 열기
                </a>
            </div>
        </div>
        {# 갤러리 네비게이션 버튼 #}
        <button type="button" class="file-preview__nav file-preview__nav--prev" id="previewPrevBtn" title="이전 파일">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
        </button>
        <button type="button" class="file-preview__nav file-preview__nav--next" id="previewNextBtn" title="다음 파일">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        </button>
    </div>
</div>
